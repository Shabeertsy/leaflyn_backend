{% extends base_template %}

{% block title %}Edit Terms & Conditions{% endblock %}

{% block stylesheets %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" />
<style>
  .ql-toolbar.ql-snow {
    background: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 4px 4px 0 0;
    padding: 8px;
  }

  .ql-container.ql-snow {
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 4px 4px;
    font-size: 16px;
  }

  #editor-container {
    min-height: 400px;
    background: #fff;
  }

  .ql-editor {
    min-height: 400px;
    padding: 15px;
  }

  .ql-font-impact { 
    font-family: Impact, sans-serif; 
  }
  
  .ql-font-courier { 
    font-family: "Courier New", monospace; 
  }
  
  .ql-font-comic { 
    font-family: "Comic Sans MS", cursive; 
  }

  .ql-font-sans-serif {
    font-family: sans-serif;
  }

  #toolbar-container .btn {
    margin-left: 5px;
  }

  .editor-error {
    border: 2px solid #dc3545 !important;
  }

  .content-error-message {
    display: none;
    color: #dc3545;
    font-size: 14px;
    margin-top: 5px;
  }

  .content-error-message.show {
    display: block;
  }

  .section {
    padding: 20px 0;
  }

  .section-header h1 {
    font-size: 28px;
    margin-bottom: 20px;
  }

  .card {
    box-shadow: 0 0 2rem 0 rgba(136, 152, 170, 0.15);
    border: 0;
    margin-bottom: 30px;
  }

  .card-header {
    background-color: #fff;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    padding: 1.25rem 1.5rem;
  }

  .card-header h4 {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
  }

  .card-body {
    padding: 1.5rem;
  }

  .card-footer {
    background-color: #fff;
    border-top: 1px solid rgba(0, 0, 0, 0.05);
    padding: 1.25rem 1.5rem;
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-group label {
    font-weight: 600;
    margin-bottom: 0.5rem;
    display: block;
  }

  .form-control {
    border: 1px solid #cad1d7;
    border-radius: 0.375rem;
    padding: 0.625rem 0.75rem;
  }

  .form-control:focus {
    border-color: #2E7D32;
    box-shadow: 0 0 0 0.2rem rgba(149, 72, 29, 0.25);
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt--7">
  <div class="section">
    <div class="section-header">
      <h1>Edit Terms & Conditions</h1>
    </div>
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h4>Update Terms & Conditions</h4>
          </div>
          <div class="card-body">
            <form method="POST" action="{% url 'edit_term_condition' term.id %}" id="termsForm" class="needs-validation" novalidate>
              {% csrf_token %}
              <div class="form-group">
                <label>Title <span class="text-danger">*</span></label>
                <input type="text" name="title" id="titleInput" value="{{ term.title }}" class="form-control" required>
                <div class="invalid-feedback">Please enter a title</div>
              </div>
              <div class="form-group">
                <label>Content <span class="text-danger">*</span></label>
                <div id="toolbar-container">
                  <select class="ql-font">
                    <option value="">Default</option>
                    <option value="impact">Impact</option>
                    <option value="courier">Courier</option>
                    <option value="comic">Comic Sans MS</option>
                    <option value="sans-serif">Sans Serif</option>
                  </select>
                  <select class="ql-size">
                    <option value="">Normal</option>
                    <option value="small">Small</option>
                    <option value="large">Large</option>
                    <option value="huge">Huge</option>
                  </select>
                  <button class="ql-bold"></button>
                  <button class="ql-italic"></button>
                  <button class="ql-underline"></button>
                  <button class="ql-strike"></button>
                  <select class="ql-color"></select>
                  <select class="ql-background"></select>
                  <button class="ql-script" value="sub"></button>
                  <button class="ql-script" value="super"></button>
                  <select class="ql-align">
                    <option value=""></option>
                    <option value="center"></option>
                    <option value="right"></option>
                    <option value="justify"></option>
                  </select>
                  <button class="ql-list" value="ordered"></button>
                  <button class="ql-list" value="bullet"></button>
                  <button class="ql-indent" value="-1"></button>
                  <button class="ql-indent" value="+1"></button>
                  <button class="ql-blockquote"></button>
                  <button class="ql-code-block"></button>
                  <button class="ql-link"></button>
                  <button class="ql-clean"></button>
                  <button type="button" id="undo-button" class="btn btn-sm btn-secondary">
                    <i class="fas fa-undo"></i>
                  </button>
                  <button type="button" id="redo-button" class="btn btn-sm btn-secondary">
                    <i class="fas fa-redo"></i>
                  </button>
                </div>
                <div id="editor-container"></div>
                <textarea name="content" id="hiddenContent" style="display:none;"></textarea>
                <div class="content-error-message" id="contentError">
                  Please enter the terms & conditions content
                </div>
              </div>
              <div class="card-footer text-right">
                <button type="submit" class="btn btn-primary" id="submitBtn">
                  <i class="fas fa-save"></i> Update
                </button>
                <a href="{% url 'terms_condition_list' %}" class="btn btn-secondary">
                  <i class="fas fa-times"></i> Cancel
                </a>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block javascripts %}
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
  // Register custom fonts
  var Font = Quill.import('formats/font');
  Font.whitelist = ['impact', 'courier', 'comic', 'sans-serif'];
  Quill.register(Font, true);

  // Initialize Quill editor
  var quill = new Quill('#editor-container', {
    modules: {
      toolbar: {
        container: '#toolbar-container'
      },
      history: {
        delay: 1000,
        maxStack: 100,
        userOnly: true
      }
    },
    placeholder: 'Edit your terms and conditions here...',
    theme: 'snow'
  });

  // Set existing content from backend into Quill and hidden field
  var existingHtml = `{% filter escapejs %}{{ term.content|safe }}{% endfilter %}`;
  if (existingHtml) {
    quill.root.innerHTML = existingHtml;
    document.getElementById('hiddenContent').value = existingHtml;
  }

  // Undo/Redo buttons
  document.getElementById('undo-button').addEventListener('click', function() {
    quill.history.undo();
  });

  document.getElementById('redo-button').addEventListener('click', function() {
    quill.history.redo();
  });

  // Form submission handler
  var form = document.getElementById('termsForm');
  var editorContainer = document.querySelector('.ql-container');
  var contentError = document.getElementById('contentError');

  form.addEventListener('submit', function(event) {
    event.preventDefault();
    event.stopPropagation();

    // Get content from Quill
    var content = quill.root.innerHTML;
    var textContent = quill.getText().trim();

    // Validate content
    var isContentValid = textContent.length > 0;

    if (isContentValid) {
      // Save content to hidden textarea
      document.getElementById('hiddenContent').value = content;
      editorContainer.classList.remove('editor-error');
      contentError.classList.remove('show');
    } else {
      editorContainer.classList.add('editor-error');
      contentError.classList.add('show');
    }

    // Check form validity
    if (form.checkValidity() && isContentValid) {
      form.submit();
    } else {
      form.classList.add('was-validated');
    }
  });

  // Remove error styling when user starts typing
  quill.on('text-change', function(delta, oldDelta, source) {
    if (source === 'user') {
      if (quill.getText().trim().length > 0) {
        editorContainer.classList.remove('editor-error');
        contentError.classList.remove('show');
      }
    }
  });

  // Bootstrap validation styling
  (function() {
    'use strict';
    window.addEventListener('load', function() {
      var forms = document.getElementsByClassName('needs-validation');
      Array.prototype.filter.call(forms, function(form) {
        form.addEventListener('submit', function(event) {
          if (form.checkValidity() === false) {
            event.preventDefault();
            event.stopPropagation();
          }
          form.classList.add('was-validated');
        }, false);
      });
    }, false);
  })();
</script>
{% endblock javascripts %}