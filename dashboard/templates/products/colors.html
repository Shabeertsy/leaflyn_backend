{% extends base_template %}

{% block title %} Product Colors {% endblock title %}

{% block stylesheets %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/classic.min.css"/>



<style>
  @media (max-width: 576px) {
    .modal-dialog {
      max-width: 95vw;
      margin: 1.75rem auto;
    }
  }
  
  .color-swatch {
    display: inline-block;
    width: 36px;
    height: 36px;
    border-radius: 8px;
    border: 2px solid #e2e8f0;
    vertical-align: middle;
    margin-right: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  
  .color-swatch:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }
  
  .modern-input-group {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: wrap;
  }
  
  .modern-input-group input[type="text"] {
    border-radius: 8px;
    border: 2px solid #e2e8f0;
    padding: 0.65rem 1rem;
    font-size: 0.95rem;
    background: #f8fafc;
    transition: all 0.2s ease;
    font-family: 'Monaco', 'Courier New', monospace;
    font-weight: 500;
  }
  
  .modern-input-group input[type="text"]:focus {
    border-color: #667eea;
    outline: none;
    background: #fff;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }
  
  .color-value-preview {
    font-family: 'Monaco', 'Courier New', monospace;
    font-size: 0.9rem;
    font-weight: 600;
    padding: 0.4rem 0.8rem;
    border-radius: 6px;
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border: 1px solid #cbd5e0;
    min-width: 90px;
    display: inline-block;
    text-align: center;
    letter-spacing: 0.5px;
  }
  
  /* Enhanced Color Picker Button */
  .color-pick-btn {
    width: 44px;
    height: 44px;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    position: relative;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    overflow: hidden;
  }
  
  .color-pick-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: inherit;
    opacity: 1;
    transition: opacity 0.3s ease;
  }
  
  .color-pick-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    border-color: #cbd5e0;
  }
  
  .color-pick-btn:active {
    transform: translateY(0);
  }
  
  .color-pick-btn .fas {
    color: #fff;
    font-size: 1.1rem;
    position: relative;
    z-index: 1;
    filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
  }
  
  /* Live preview indicator */
  .color-preview-live {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: #f8fafc;
    border-radius: 8px;
    border: 2px dashed #e2e8f0;
    margin-top: 0.5rem;
  }
  
  .color-preview-live .preview-swatch {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    border: 2px solid #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
  }
  
  .color-preview-live .preview-text {
    font-size: 0.85rem;
    color: #64748b;
    font-weight: 500;
  }
  
  /* Enhanced Pickr Styling */
  .pickr {
    position: relative;
  }
  
  .pickr .pcr-app {
    border-radius: 12px !important;
    border: 2px solid #e2e8f0 !important;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15) !important;
    overflow: hidden;
  }
  
  .pickr .pcr-selection {
    border-radius: 8px !important;
  }
  
  .pickr .pcr-interaction {
    padding: 1rem !important;
  }
  
  .pickr .pcr-interaction input {
    border-radius: 6px !important;
    border: 2px solid #e2e8f0 !important;
    background: #f8fafc !important;
    padding: 0.5rem !important;
    font-family: 'Monaco', 'Courier New', monospace !important;
    transition: all 0.2s ease !important;
  }
  
  .pickr .pcr-interaction input:focus {
    border-color: #667eea !important;
    background: #fff !important;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1) !important;
  }
  
  .pickr .pcr-swatches {
    background: #fff !important;
    padding: 0.75rem !important;
    border-radius: 8px !important;
  }
  
  .pickr .pcr-swatches > button {
    border-radius: 6px !important;
    border: 2px solid #fff !important;
    margin: 0.25rem !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
    transition: all 0.2s ease !important;
  }
  
  .pickr .pcr-swatches > button:hover {
    transform: scale(1.15) !important;
    box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
  }
  
  .pickr .pcr-button {
    border-radius: 8px !important;
    border: 2px solid #e2e8f0 !important;
    transition: all 0.2s ease !important;
  }
  
  .pickr .pcr-button:hover {
    border-color: #cbd5e0 !important;
  }
  
  .pickr .pcr-save {
    background: #667eea !important;
    color: white !important;
    font-weight: 600 !important;
    border-radius: 6px !important;
    padding: 0.5rem 1rem !important;
  }
  
  .pickr .pcr-save:hover {
    background: #5568d3 !important;
  }
  
  .pickr .pcr-clear {
    background: #ef4444 !important;
    color: white !important;
  }
  
  /* Form group enhancements */
  .form-group label {
    font-weight: 600;
    color: #334155;
    margin-bottom: 0.5rem;
    display: block;
  }
  
  /* Pulsing animation for active picker */
  @keyframes pulse-ring {
    0% {
      box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.4);
    }
    70% {
      box-shadow: 0 0 0 8px rgba(102, 126, 234, 0);
    }
    100% {
      box-shadow: 0 0 0 0 rgba(102, 126, 234, 0);
    }
  }
  
  .color-pick-btn.active {
    animation: pulse-ring 1.5s infinite;
  }
</style>
{% endblock stylesheets %}


{% block content %}
<div class="container-fluid mt--6">
  <div class="row">
    <div class="col">
      <div class="card">
        <div class="card-header border-0 d-flex justify-content-between align-items-center flex-wrap">
          <div class="d-flex align-items-center">
            <button type="button" class="ad-style-btn mr-3" data-toggle="modal" data-target="#addColorModal" aria-label="Add New Color">
              <span class="btn-icon">
                <i class="fas fa-plus"></i>
              </span>
              <span class="add-tooltip">Add Color</span>
              <span class="sr-only">Add New Color</span>
            </button>
            <h3 class="mb-0">Product Colors</h3>
          </div>
          <form method="get" class="search-input-group" style="max-width: 350px;">
            <div class="search-box">
              <span class="search-icon">
                <i class="fas fa-search"></i>
              </span>
              <input type="text" name="search" class="form-control" placeholder="Search colors..." value="{{ request.GET.search|default_if_none:'' }}">
              <button class="search-btn" type="submit" aria-label="Search">
                <i class="fas fa-arrow-right"></i>
              </button>
              {% if request.GET.search %}
              <a href="{% url 'product_colors' %}" class="clear-search" title="Clear search">
                <i class="fas fa-times"></i>
              </a>
              {% endif %}
            </div>
          </form>
        </div>
        <div class="px-4 pt-3">
          {% if messages %}
            <div class="custom-message-container" id="custom-message-container">
              {% for message in messages %}
                {% if "color-success" in message.tags %}
                  <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <span class="d-flex align-items-center">
                      <i class="fas fa-check-circle mr-2"></i>
                      <span>{{ message }}</span>
                    </span>
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close" style="pointer-events:auto;">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                {% elif "color-error" in message.tags %}
                  <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <span class="d-flex align-items-center">
                      <i class="fas fa-exclamation-circle mr-2"></i>
                      <span>{{ message }}</span>
                    </span>
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close" style="pointer-events:auto;">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                {% else %}
                  <div class="alert alert-info alert-dismissible fade show" role="alert">
                    <span class="d-flex align-items-center">
                      <i class="fas fa-info-circle mr-2"></i>
                      <span>{{ message }}</span>
                    </span>
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close" style="pointer-events:auto;">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          {% endif %}
        </div>
        <div class="table-responsive">
          <table class="table align-items-center table-flush">
            <thead class="thead-light">
              <tr>
                <th scope="col">#</th>
                <th scope="col">Color Name</th>
                <th scope="col">Value</th>
                <th scope="col">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for color in colors %}
              <tr>
                <td>{{ forloop.counter0|add:colors.start_index }}</td>
                <td>
                  {% if color.name %}
                    {{ color.name }}
                  {% else %}
                    <span class="text-muted">N/A</span>
                  {% endif %}
                </td>
                <td>
                  {% if color.color %}
                    <span class="color-swatch" style="background: {{ color.color }}"></span>
                    <span class="color-value-preview">{{ color.color }}</span>
                  {% else %}
                    <span class="text-muted">â€”</span>
                  {% endif %}
                </td>
                <td class="action-btns">
                  <button type="button"
                          class="btn btn-sm btn-primary"
                          title="Edit"
                          data-toggle="modal"
                          data-target="#editColorModal-{{ color.id }}"
                          data-bs-toggle="modal"
                          data-bs-target="#editColorModal-{{ color.id }}">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button type="button"
                          class="btn btn-sm btn-danger ml-1"
                          title="Delete"
                          data-toggle="modal"
                          data-target="#deleteColorModal-{{ color.id }}"
                          data-bs-toggle="modal"
                          data-bs-target="#deleteColorModal-{{ color.id }}">
                    <i class="fas fa-trash-alt"></i>
                    <span class="sr-only">Delete</span>
                  </button>
                </td>
              </tr>

              <!-- Edit Color Modal -->
              <div class="modal fade" id="editColorModal-{{ color.id }}" tabindex="-1" aria-labelledby="editColorModalLabel-{{ color.id }}" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered" role="document">
                  <div class="modal-content">
                    <form method="post" action="{% url 'edit_product_color' color.id %}" class="needs-validation" novalidate>
                      {% csrf_token %}
                      <div class="modal-header justify-content-center" style="background: #C8E6C9;">
                        <h6 class="modal-title w-100 text-center mb-0" id="editColorModalLabel-{{ color.id }}">Edit Color</h6>
                        <button type="button" class="close position-absolute" style="right: 1rem; top: 1rem;" data-dismiss="modal" data-bs-dismiss="modal" aria-label="Close">
                          <span aria-hidden="true">&times;</span>
                        </button>
                      </div>
                      <div class="modal-body">
                        <div class="form-group">
                          <label for="edit_color_name_modal_{{ color.id }}">Color Name <span class="text-muted font-italic">(optional)</span></label>
                          <div class="modern-input-group">
                            <input type="text" 
                                   class="form-control" 
                                   id="edit_color_name_modal_{{ color.id }}" 
                                   name="name" 
                                   value="{{ color.name|default_if_none:'' }}" 
                                   placeholder="Enter color name" 
                                   autocomplete="off">
                          </div>
                        </div>
                        <div class="form-group">
                          <label for="edit_color_value_modal_{{ color.id }}">Color Value <span class="text-danger">*</span></label>
                          <div class="modern-input-group">
                            <input type="text" 
                                   class="form-control" 
                                   id="edit_color_value_modal_{{ color.id }}" 
                                   name="color" 
                                   value="{{ color.color }}" 
                                   placeholder="#RRGGBB" 
                                   required 
                                   pattern="^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$" 
                                   autocomplete="off" 
                                   style="max-width: 120px;">
                            <button type="button" class="color-pick-btn" id="edit-color-pick-btn-{{ color.id }}" style="background: {{ color.color|default:'#667eea' }};" tabindex="0" aria-label="Pick color">
                              <i class="fas fa-eye-dropper"></i>
                            </button>
                          </div>
                          <div class="color-preview-live" id="edit-preview-{{ color.id }}" style="margin-top: 0.75rem;">
                            <span class="preview-swatch" style="background: {{ color.color }}"></span>
                            <span class="preview-text">Live Preview</span>
                          </div>
                          <small class="form-text text-muted mt-2">Pick a color or enter a hex value (e.g. #ff0000)</small>
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Color</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              <!-- Delete Color Modal -->
              <div class="modal fade modal-confirm" id="deleteColorModal-{{ color.id }}" tabindex="-1" aria-labelledby="deleteColorModalLabel-{{ color.id }}" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered" role="document">
                  <div class="modal-content">
                    <div class="modal-header border-0">
                      <div class="icon-box mx-auto">
                        <i class="fas fa-exclamation-triangle"></i>
                      </div>
                    </div>
                    <div class="modal-body text-center">
                      <h5 class="modal-title mb-2" id="deleteColorModalLabel-{{ color.id }}">Delete Color</h5>
                      <div class="d-flex align-items-center justify-content-center mb-3">
                        <span class="color-swatch mr-2" style="background: {{ color.color }}"></span>
                        <span>
                          <strong>{{ color.name|default:"(No Name)" }}</strong>
                          <span class="color-value-preview">{{ color.color }}</span>
                        </span>
                      </div>
                      <p>Are you sure you want to delete this color?</p>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-dismiss="modal" data-bs-dismiss="modal">Cancel</button>
                      <a href="{% url 'delete_product_color' color.id %}" class="btn btn-danger">Delete</a>
                    </div>
                  </div>
                </div>
              </div>
              {% empty %}
              <tr>
                <td colspan="4" class="text-center text-muted">No data found.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% if colors.has_other_pages %}
        <div class="card-footer py-4">
          <nav aria-label="Color pagination">
            <ul class="pagination justify-content-end mb-0">
              {% if colors.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ colors.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}" tabindex="-1">
                    <i class="fas fa-angle-left"></i>
                  </a>
                </li>
              {% else %}
                <li class="page-item disabled">
                  <span class="page-link"><i class="fas fa-angle-left"></i></span>
                </li>
              {% endif %}
              {% for i in colors.paginator.page_range %}
                {% if colors.number == i %}
                  <li class="page-item active"><span class="page-link">{{ i }}</span></li>
                {% else %}
                  <li class="page-item"><a class="page-link" href="?page={{ i }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">{{ i }}</a></li>
                {% endif %}
              {% endfor %}
              {% if colors.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ colors.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">
                    <i class="fas fa-angle-right"></i>
                  </a>
                </li>
              {% else %}
                <li class="page-item disabled">
                  <span class="page-link"><i class="fas fa-angle-right"></i></span>
                </li>
              {% endif %}
            </ul>
          </nav>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Add Color Modal -->
<div class="modal fade" id="addColorModal" tabindex="-1" aria-labelledby="addColorModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <form method="post" action="{% url 'add_product_color' %}" class="needs-validation" novalidate>
        {% csrf_token %}
        <div class="modal-header justify-content-center" style="background: #C8E6C9;">
          <h6 class="modal-title w-100 text-center mb-0" id="addColorModalLabel">Add New Color</h6>
          <button type="button" class="close position-absolute" style="right: 1rem; top: 1rem;" data-dismiss="modal" data-bs-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group mb-3">
            <label for="color_name_modal">Color Name <span class="text-muted font-italic">(optional)</span></label>
            <div class="modern-input-group">
              <input type="text" class="form-control" id="color_name_modal" name="name" placeholder="Enter color name" autocomplete="off">
            </div>
          </div>
          <div class="form-group mb-3">
            <label for="color_value_modal">Color Value <span class="text-danger">*</span></label>
            <div class="modern-input-group">
              <input type="text" class="form-control" id="color_value_modal" name="color" placeholder="#RRGGBB" required pattern="^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$" autocomplete="off" style="max-width: 120px;">
              <button type="button" class="color-pick-btn" id="add-color-pick-btn" style="background: #667eea;" tabindex="0" aria-label="Pick color">
                <i class="fas fa-eye-dropper"></i>
              </button>
            </div>
            <div class="color-preview-live" id="add-preview" style="margin-top: 0.75rem;">
              <span class="preview-swatch" style="background: #667eea"></span>
              <span class="preview-text"> Preview</span>
            </div>
            <small class="form-text text-muted mt-2">Pick a color or enter a hex value (e.g. #ff0000)</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Color</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock content %}

{% block javascripts %}
<script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/pickr.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  
  // Utility function to update live preview
  function updateLivePreview(color, previewId) {
    const preview = document.getElementById(previewId);
    if (preview) {
      const swatch = preview.querySelector('.preview-swatch');
      if (swatch) {
        swatch.style.background = color;
      }
    }
  }
  
  // Add Color Modal Picker
  const addColorPickBtn = document.getElementById('add-color-pick-btn');
  const addColorInput = document.getElementById('color_value_modal');
  let addPickr = null;

  function initAddPickr() {
    if (addPickr) return;
    
    const defaultColor = addColorInput.value || '#667eea';
    
    addPickr = Pickr.create({
      el: addColorPickBtn,
      theme: 'classic',
      default: defaultColor,
      useAsButton: true,
      swatches: [
        '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8',
        '#6C5CE7', '#A29BFE', '#FD79A8', '#FDCB6E', '#00B894',
        '#FF7675', '#74B9FF', '#A29BFE', '#55EFC4', '#FAB1A0',
        '#667eea', '#764ba2', '#f093fb', '#4facfe', '#00f2fe'
      ],
      components: {
        preview: true,
        opacity: false,
        hue: true,
        interaction: {
          hex: true,
          rgba: false,
          hsla: false,
          hsva: false,
          cmyk: false,
          input: true,
          save: true,
          clear: false
        }
      },
      closeOnScroll: false
    });

    addPickr.on('init', instance => {
      const color = addPickr.getColor().toHEXA().toString();
      addColorInput.value = color;
      addColorPickBtn.style.background = color;
      updateLivePreview(color, 'add-preview');
    });

    addPickr.on('change', (color, instance) => {
      if (color) {
        const hex = color.toHEXA().toString();
        addColorInput.value = hex;
        addColorPickBtn.style.background = hex;
        updateLivePreview(hex, 'add-preview');
        addColorPickBtn.classList.add('active');
      }
    });

    addPickr.on('save', (color, instance) => {
      if (color) {
        const hex = color.toHEXA().toString();
        addColorInput.value = hex;
        addColorPickBtn.style.background = hex;
        updateLivePreview(hex, 'add-preview');
      }
      addPickr.hide();
      addColorPickBtn.classList.remove('active');
    });

    addPickr.on('hide', instance => {
      addColorPickBtn.classList.remove('active');
    });

    addColorInput.addEventListener('input', function() {
      const val = this.value.trim();
      if (/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(val)) {
        try {
          addPickr.setColor(val);
          addColorPickBtn.style.background = val;
          updateLivePreview(val, 'add-preview');
        } catch(e) {
          console.log('Invalid color format');
        }
      }
    });

    // Real-time validation feedback
    addColorInput.addEventListener('blur', function() {
      const val = this.value.trim();
      if (val && !/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(val)) {
        this.classList.add('is-invalid');
      } else {
        this.classList.remove('is-invalid');
      }
    });
  }

  $('#addColorModal').on('show.bs.modal', function () {
    initAddPickr();
    const currentColor = addColorInput.value || '#667eea';
    if (addPickr) {
      addPickr.setColor(currentColor);
    }
    addColorPickBtn.style.background = currentColor;
    updateLivePreview(currentColor, 'add-preview');
  });

  $('#addColorModal').on('hide.bs.modal', function () {
    if (addPickr) {
      addPickr.hide();
      addColorPickBtn.classList.remove('active');
    }
  });

  // Edit Color Modal Pickers
  {% for color in colors %}
  (function() {
    const colorId = '{{ color.id }}';
    const editColorPickBtn = document.getElementById('edit-color-pick-btn-' + colorId);
    const editColorInput = document.getElementById('edit_color_value_modal_' + colorId);
    let editPickr = null;

    function initEditPickr() {
      if (editPickr) return;
      
      const defaultColor = editColorInput.value || '{{ color.color|default:"#667eea" }}';
      
      editPickr = Pickr.create({
        el: editColorPickBtn,
        theme: 'classic',
        default: defaultColor,
        useAsButton: true,
        swatches: [
          '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8',
          '#6C5CE7', '#A29BFE', '#FD79A8', '#FDCB6E', '#00B894',
          '#FF7675', '#74B9FF', '#A29BFE', '#55EFC4', '#FAB1A0',
          '#667eea', '#764ba2', '#f093fb', '#4facfe', '#00f2fe'
        ],
        components: {
          preview: true,
          opacity: false,
          hue: true,
          interaction: {
            hex: true,
            rgba: false,
            hsla: false,
            hsva: false,
            cmyk: false,
            input: true,
            save: true,
            clear: false
          }
        },
        closeOnScroll: false
      });

      editPickr.on('init', instance => {
        const color = editPickr.getColor().toHEXA().toString();
        editColorInput.value = color;
        editColorPickBtn.style.background = color;
        updateLivePreview(color, 'edit-preview-' + colorId);
      });

      editPickr.on('change', (color, instance) => {
        if (color) {
          const hex = color.toHEXA().toString();
          editColorInput.value = hex;
          editColorPickBtn.style.background = hex;
          updateLivePreview(hex, 'edit-preview-' + colorId);
          editColorPickBtn.classList.add('active');
        }
      });

      editPickr.on('save', (color, instance) => {
        if (color) {
          const hex = color.toHEXA().toString();
          editColorInput.value = hex;
          editColorPickBtn.style.background = hex;
          updateLivePreview(hex, 'edit-preview-' + colorId);
        }
        editPickr.hide();
        editColorPickBtn.classList.remove('active');
      });

      editPickr.on('hide', instance => {
        editColorPickBtn.classList.remove('active');
      });

      editColorInput.addEventListener('input', function() {
        const val = this.value.trim();
        if (/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(val)) {
          try {
            editPickr.setColor(val);
            editColorPickBtn.style.background = val;
            updateLivePreview(val, 'edit-preview-' + colorId);
          } catch(e) {
            console.log('Invalid color format');
          }
        }
      });

      // Real-time validation feedback
      editColorInput.addEventListener('blur', function() {
        const val = this.value.trim();
        if (val && !/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(val)) {
          this.classList.add('is-invalid');
        } else {
          this.classList.remove('is-invalid');
        }
      });
    }

    $('#editColorModal-' + colorId).on('show.bs.modal', function() {
      initEditPickr();
      const currentColor = editColorInput.value || '{{ color.color|default:"#667eea" }}';
      if (editPickr) {
        editPickr.setColor(currentColor);
      }
      editColorPickBtn.style.background = currentColor;
      updateLivePreview(currentColor, 'edit-preview-' + colorId);
    });

    $('#editColorModal-' + colorId).on('hide.bs.modal', function() {
      if (editPickr) {
        editPickr.hide();
        editColorPickBtn.classList.remove('active');
      }
    });

    // Hide picker when form is submitted
    const form = document.querySelector('#editColorModal-' + colorId + ' form');
    if (form) {
      form.addEventListener('submit', function() {
        if (editPickr) {
          editPickr.hide();
          editColorPickBtn.classList.remove('active');
        }
      });
    }
  })();
  {% endfor %}
  
  // Auto-dismiss alerts after 5 seconds
  setTimeout(function() {
    const alerts = document.querySelectorAll('.alert');
    alerts.forEach(function(alert) {
      $(alert).fadeOut('slow', function() {
        $(this).remove();
      });
    });
  }, 5000);
});
</script>
{% endblock javascripts %}